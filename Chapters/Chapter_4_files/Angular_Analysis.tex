
The core formalism and all the necessary steps towards building a \pdf to describe the amplitude properties and angular structure of \BJpsiKst decays are presented in
the current section. A brief description of the angular \pdf derivation is given in \secref{Diferential_Decay_Rate}.
Treatment of the angular acceptance is addressed in \secref{Accceptance} and \secref{Accceptance_Corrections}.
In \secref{Kpi_Invariant_mass} the implications arising from the \mkpi dependence are discussed.
The effect of asymmetries introduced by detector imperfections such as production and detection asymmetries are dealt with
in \secref{experimentalAssym}. Some aspects of the maximum likelihood fit are presented in \secref{Simutaneous_Likelihood_fit},
along with the \Acp{k} parameters of interest, which are introduced in a special way in the angular fit when building the full decay rate \pdf.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Angular Dependence}
\label{Diferential_Decay_Rate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The decay of interest, \BsJpsiKst, is a \PtoVV process with 4 charged particles in the final state.
The symbols in \PtoVV refers to the spin of the particles involved in the decay.
Specifically, the \Bs (and \Bd) is a spin zero parity minus particle (or pseudo-scalar), whereas the intermediate resonances
\jpsi and \Kstarzb are spin one (or vector) particles. The final state particles are
two muons, \mmu, and a kaon-pion pair, $\kaon\pion$, coming from the decay of the \jpsi and \Kstarzb respectively.
The angular dependence of the \BsJpsiKst decay can be described using either the transversity framework \cite{transvFrameworkI,transvFrameworkII}
or the helicity formalism \cite{helicityFormI,helicityFormII}. For the current analysis the helicity
formalism is adopted. This implies that the angular dependence is introduced by summing all possible
spin configurations of the intermediate vector particles relative to their momentum direction in the
\Bs rest mass frame and squaring the sum. Or, in more compact wording, from summing up all possible
helicity configurations of the intermediate vector particles. A detailed derivation of both approaches
within the scope of a \PtoVV decay can be found in \cite{daanThesis} and \cite{jeroenThesis} respectively
for the transversity and helicity formalism.

\begin{figure}[t]
  \centering
  \includegraphics[width=\textwidth]{Figures/Chapter4/helAngles}
  \caption{Definition of helicity angles.}
  \label{helAngles}
\end{figure}

Here, the steps to arrive at an expression for the angular decay rate of \BsJpsiKst are briefly described.
The total decay amplitude $\mathcal{A}(\text{\BJpsiKst})$ is decomposed in its \pwave ($0$, $\parallel$, $\perp$)
and \swave ($S$) polarizations as shown in the following equation:

\begin{align}
  \centering
  \frac{d\Gamma(\text{\BJpsiKst})}{d\Omega\;d\mkpi} &\propto |\mathcal{A}(\text{\BJpsiKst})|^2 = \nonumber \\
                                                    &= \left| \sum_i^{0,\parallel,\perp,S} A_i(\Omega,\mkpi) \right|^2  \propto \sum_n a_n h_n \mKpiAmp.
  \label{ang_terms}
\end{align}

\noindent The terms $a_n$ originate from squaring the amplitude and their exact expressions are shown in \tabref{ang_distr}.
Note the appearance of the $\Re$ and $\Im$ interference terms as well. The full derivation of the above table can be found in \cite{jeroenThesis}.
The functions $h_n$ and $\mKpiAmp$ represent the angular dependence of each $a_n$ term and the \mkpi
dependence of the amplitude respectively. The description of the \mkpi dependence is postponed for the next section. \tabref{ang_distr}
lists the angular part of the decay rate equation, \ie the $h_n$ functions, which are the result of
applying the helicity formalism in the \BJpsiKst decay. In order to describe the 4-body decay \BJpsiKst, three
angles, denoted by $\Omega$, plus \mkpi are required. As shown in \figref{helAngles}, the three \emph{helicity angles} angles
$\thetaK$, $\thetamu$ and $\phihel$, are defined as follows: $\thetamu$ is the angle of the positive $\mu$ with respect to the
momentum of the \jpsi in the \Bs rest frame; similarly for $\thetaK$, the \kaon is used to define the angle with respect to
the momentum of the intermediate \Kpi resonance; finally $\phihel$ is the relative angle between the \Kpi and dimuon decay
planes, where each plane is defined in the rest frame of the corresponding intermediate resonance.

\begin{table}[t]
  \centering
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{cc}
    \hline
      $a_n$  &
      $h_n(\Omega) \times 16\sqrt{\pi}$       \\ %&
      % $h_n(\Omega) \times \tfrac{32\pi}{9}$   \\

    \hline
      $\AmpSq{0}$   &
      $4\, (P_0^0 + 2\, P_2^0)\, (Y_{0,\,0} - \tfrac{1}{\sqrt{5}}\, Y_{2,\,0})$  \\ %&
      % $2\, \cos^2\thetaK\, \sin^2\thetamu$  \\

    $\AmpSq{\parallel}$  &
      $P_2^2\, (2\, Y_{0,\,0} + \tfrac{1}{\sqrt{5}}\, Y_{2,\,0} - \sqrt{\tfrac{3}{5}}\, Y_{2,\,+2})$ \\ % &
      % $\sin^2\thetaK\, (1 - \sin^2\thetamu\, \cos^2\phihel)$  \\

    $\AmpSq{\perp}$  &
      $P_2^2\, (2\, Y_{0,\,0} + \tfrac{1}{\sqrt{5}}\, Y_{2,\,0} + \sqrt{\tfrac{3}{5}}\, Y_{2,\,+2})$  \\ %&
      % $\sin^2\thetaK\, (1 - \sin^2\thetamu\, \sin^2\phihel)$  \\

    $\ReAmp{0}{\parallel}$  &
      $+2\sqrt{2}\sqrt{\tfrac{3}{5}}\, P_2^1\, Y_{2,\,+1}$  \\ %&
      % $+\frac{1}{\sqrt{2}}\, \sin2\thetaK\, \sin2\thetamu\, \cos\phihel$  \\

    $\ImAmp{0}{\perp}$  &
      $-2\sqrt{2}\sqrt{\tfrac{3}{5}}\, P_2^1\, Y_{2,\,-1}$  \\ %&
      % $-\frac{1}{\sqrt{2}}\, \sin2\thetaK\, \sin2\thetamu\, \sin\phihel$  \\


    $\ImAmp{\parallel}{\perp}$  &
      $+2\sqrt{\tfrac{3}{5}}\, P_2^2\, Y_{2,\,-2}$  \\ %&
      % $+\sin^2\thetaK\, \sin^2\thetamu\, \sin2\phihel$  \\

    \hline
    $\AmpSq{{\text{S}}}$  &
      $4\, P_0^0\, (Y_{0,\,0} - \tfrac{1}{\sqrt{5}}\, Y_{2,\,0})$  \\ %&
      % $\tfrac{2}{3}\, \sin^2\thetamu$  \\

    $\ReAmp{0}{{\text{S}}}$  &
      $8\sqrt{3}\, P_1^0\, (Y_{0,\,0} - \tfrac{1}{\sqrt{5}}\, Y_{2,\,0})$ \\ % &
      % $\tfrac{4}{3}\sqrt{3}\, \cos\thetaK\, \sin^2\thetamu$  \\

    $\ReAmp{\parallel}{{\text{S}}}$  &
      $+6\sqrt{2}\tfrac{1}{\sqrt{5}}\, P_1^1\, Y_{2,\,+1}$  \\ % &
      % $+\tfrac{1}{3}\sqrt{6}\, \sin\thetaK\, \sin2\thetamu\, \cos\phihel$  \\

    $\ImAmp{\perp}{{\text{S}}}$  &
      $+6\sqrt{2}\tfrac{1}{\sqrt{5}}\, P_1^1\, Y_{2,\,-1}$  \\ %&
      % $+\tfrac{1}{3}\sqrt{6}\, \sin\thetaK\, \sin2\thetamu\, \sin\phihel$  \\
    \hline
  \end{tabular}
  \caption{Angular functions corresponding to each term in \equref{ang_terms}. Pure and interference \pwave terms are shown in the upper part,
    whereas the \swave plus \spwave interference in the lower. The angular functions, $h_n$, are expressed in the helicity basis.
    The $P$ and $Y$ denote associated Legendre polynomials and real valued spherical harmonics respectively.}
  \label{ang_distr}
\end{table}

Lastly, the orthogonal angular basis of $P$ and $Y$ is adopted in the current analysis.
This choice is favoured by the fact that the integrals of the product of two $P$ or two $Y$ are known analytically.
The latter significantly improves the description and implementation of the angular acceptance described in the following section.
Note that the decomposition of angular functions in an orthogonal basis follows naturally from the fact that spherical
harmonics can be expressed as Wigner-$D$ matrices.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Acceptance}
\label{Accceptance}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The effects of angular resolution are known to be small for this analysis \cite{tristanThesis},
however, sources introducing angular acceptance need to be explicitly accounted for.
Deviations from a perfect angular acceptance can be introduced by selection criteria mentioned in \secref{Event_Selection} or by the detector itself.
As explained in \secref{lhcb_detector} the \lhcb detector does not cover the full $4\pi$ solid angle.
The current section introduces the treatment of the angular acceptance function. After that the parametrization
of the acceptance is discussed and finally an important issue related to the choice of parametrization is dealt with.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.49\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_mc_helcosthetaK_allKaons_binall}
    \scalebox{1.12}{\input{Figures/Chapter4/eff_mc_helcosthetaK_allKaons_binall}}
    \caption{}
    \label{angAcc_ctk}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.49\textwidth}
    \raggedleft
    \tikzsetnextfilename{eff_mc_helcosthetaL_allKaons_binall}
    \scalebox{1.12}{\input{Figures/Chapter4/eff_mc_helcosthetaL_allKaons_binall}}
    \caption{}
    \label{angAcc_ctl}
  \end{subfigure}
  \vspace*{0.02\textwidth}
  \begin{subfigure}{0.49\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_mc_helphi_allKaons_binall}
    \scalebox{1.12}{\input{Figures/Chapter4/eff_mc_helphi_allKaons_binall}}
    \caption{}
    \label{angAcc_phi}
  \end{subfigure}
  \caption{Angular acceptance shape from simulated data. Each candidate has been assigned a weight. Each weight is
           equal to one over the integral of the \pdf that was used to generate the angular distribution of the simulated data.}
  \label{angAcc_all}
\end{figure}

The shape of the acceptance can be seen in \figref{angAcc_all}. The most striking feature is the drop of efficiency
close to $\cos\thetaK=1$. The later is mainly caused by one of the candidate selection requirements of \tabref{Bs2JpsiKstSelection},
specifically the requirement on the \kaon and \pion transverse momentum, \pt, to be larger that $500\mevc$.
Before attempting to explain the acceptance shape it is useful to illustrate how the decay angles are
distributed according to the \pdf of \equref{ang_terms}, \ie without any acceptance effect, see \figref{angDistr_all}.

Understanding the shape of the acceptance in the $\cos\thetaK$ projection begins with the observation
that the phase space region of $(\ptrans{\pi}-\cos\thetaK)$ is not uniformly populated. This is related to kinematic
constrains, explained in the next paragraph. Qualitatively speaking, it turns out that \Bs decays tend to cluster
close to the region of $(\ptrans{\pi}-\cos\thetaK|_{-1})$ compared to the $(\ptrans{\pi}-\cos\thetaK|_{+1})$ region.
This picture is less pronounced in the case of $(\ptrans{\kaon}-\cos\thetaK)$ phase space region, where the $\ptrans{\kaon}$
spectrum is harder and the $(\ptrans{\kaon}-\cos\thetaK)$ is more symmetric with respect to $\cos\thetaK$, see \figref{ctk_hadrons_pt}.
Given these correlations it follows that applying the \pt requirement on both \kaon and \pion makes the $\cos\thetaK$ distribution
asymmetric around $\cos\thetaK=0$.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.33\textwidth}
    \tikzsetnextfilename{mc_ang_ctk}
    \scalebox{0.65}{\input{Figures/Chapter4/mc_ang_ctk}}
    \caption{}
    \label{angDistr_ctk}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.33\textwidth}
    \tikzsetnextfilename{mc_ang_ctl}
    \scalebox{0.65}{\input{Figures/Chapter4/mc_ang_ctl}}
    \caption{}
    \label{angDistr_ctl}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.33\textwidth}
    \tikzsetnextfilename{mc_ang_phi}
    \scalebox{0.65}{\input{Figures/Chapter4/mc_ang_phi}}
    \caption{}
    \label{angDistr_phi}
  \end{subfigure}
  \caption{Decay angles distributions from simulation data. No detector effects and no selection are included.
           Histograms are normalized to unity area.}
  \label{angDistr_all}
\end{figure}

The above situation is related to kinematic constrains in two body decays particularly close to phase
space boundaries. The latter constraint manifests itself when computing the angle of the pion
with respect to the boost direction in the lab frame, as shown in the following equation:

\begin{equation}
  \centering
  \tan\thetapi^\lab = \frac{\ptrans{\pi}^\lab}{\plongd{\pi}^\lab}
               = \frac{\ptrans{\pi}}{\gamma\parenthesis{\plongd{\pi} + \beta E_\pi} }
               = \frac{\ptot_{\pi} \sin\thetapi}{\gamma\parenthesis{\ptot_{\pi} \cos\thetapi + \beta E_\pi} },
  \label{pi_angle}
\end{equation}

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.49\textwidth}
    \raggedright
    \tikzsetnextfilename{ctk_kaon_kaon_pt}
    \scalebox{1.15}{\input{Figures/Chapter4/ctk_kaon_kaon_pt}}
    \caption{}
    \label{ctk_kaon_pt}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.49\textwidth}
    \raggedleft
    \tikzsetnextfilename{ctk_kaon_pion_pt}
    \scalebox{1.15}{\input{Figures/Chapter4/ctk_kaon_pion_pt}}
    \caption{}
    \label{ctk_pion_pt}
  \end{subfigure}
  \caption{Two dimensional histograms of kaon (left) and pion (right) transverse momentum in the lab frame versus $\cos\thetaK$.
           No detector effects and no selection are included. The area of the boxes reflect the number of bin entries.}
  \label{ctk_hadrons_pt}
\end{figure}

\noindent where, $\thetapi^\lab$ is the angle of the pion momentum vector with respect to the boost direction
in the lab frame. Absence of the \lab superscript refers to quantities computed in the \Kstarz rest frame.
The subscripts T,L label the transverse and longitudinal components of the pion momentum, $\ptot_{\pi}$.
The symbol $E$ stands for the energy of the pions. The Lorentz boost factor and the relativistic speed
are labeled by $\gamma$ and $\beta$ respectively. The angle $\thetapi$ is the angle of the pion momentum,
in the \Kstarz rest frame, which is related to $\thetaK$ in \figref{helAngles} as: $\thetapi = \thetaK + \pi$.
Now, the origin of the above-mentioned asymmetry is understood better in the limit of a massless pion,
in which case \equref{pi_angle} reduces to:

\begin{equation}
  \centering
  \tan\thetapi^\lab = \frac{\sin\thetapi}{\gamma\parenthesis{\cos\thetapi + 1} }.
  \label{pi_angle_massless}
\end{equation}

\noindent Note that the energy of a massless particle is equal to its total momentum and also that $\beta \simeq 1$
for pions coming from \BJpsiKpi decays in \lhcb. From \equref{pi_angle_massless} it follows that decays where $\cos\thetapi=-1$
are not allowed. The situation corresponds to a low transverse momentum pion for which $\cos\thetaK = -\cos\thetapi = +1$.
This explains why the shape of the $\cos\thetaK$ distribution becomes asymmetric when excluding low momenta pions.
This effect is more general and it is driven by the mass difference between the two particles in a two body decay.

Coming now to the case of the $\cos\thetamu$ acceptance shape, the two decay products of the \jpsi have
the same mass and thus get the same momentum fraction out of the mother \jpsi particle. A consequence of
the latter is that the transverse momentum spectrum of the two muons is identical, excluding detector
resolution, and thus the two muons populate the $(\pt-\cos\thetamu)$ plane similarly. Based on the latter
it follows that excluding low transverse momentum muons does not introduce any asymmetry in the $\cos\thetamu$ distribution.

As for the acceptance in the $\phihel$ plane it is very close to being uniform.
No strong acceptance effect in that projection is expected.

\subsubsection{Acceptance parametrization}
\label{Acceptance parametrization}
As for the parametrization of the angular acceptance, there are at least two ways to proceed,
namely the \emph{efficiency moments} \cite{jeroenThesis} and the \emph{normalization weights} \cite{tristanThesis,jeroenThesis}.
The current analysis implements the first one. The efficiency function is thus parameterized using orthogonal polynomials,
which, when combined with the angular description formalism in the previous subsection, allows for fast analytic
integration. Such a parametrization is:

\begin{equation}
  \centering
  \epsilon(\Omega) = \sum_{ijk} \; \moment{i}{j}{k} \; P_i^0(\cos\thetaK) \; Y_{jk}(\cos\thetamu,\phihel) \equiv \moment{i}{j}{k} \; \effbase,
  \label{eff_func}
\end{equation}

\noindent where the real-valued spherical harmonics ($Y$) and associated Legendre polynomials ($P$) are used as the basis
functions to which the angular acceptance is decomposed by means of the coefficients $c^i_{k}$, hereafter efficiency moments or simply moments.
Following the parametrization of \equref{eff_func} one just needs to obtain a set of $c^i_{jk}$. Note that there are \aprior infinite efficiency moments
since the sum in \equref{eff_func} runs through all possible values of the $ijk$ indices. However, in practice only a small number of efficiency moments
contribute significantly to the angular acceptance shape. This is due to the fact that higher moments introduce
variations on the acceptance shape that are effectively washed out by the finite angular resolution.

The efficiency moments used to describe the acceptance shape are shown in the first column of \tabref{eff_moms_table}.
The larger the value of a moment, the more the corresponding function contributes to the overall efficiency function.
The efficiency functions $P_1^0Y_{00}$ and $P_2^0Y_{00}$ account for most of the hard acceptance drop in the $\cos\thetaK$ projection.
This is supported by the large value of the corresponding moments $\moment{1}{0}{0}$ and $\moment{2}{0}{0}$.
The choice of the particular efficiency moments, is connected to an important
issue with the acceptance structure close to $\cos\thetaK=1$ and it is addressed at the end of the current section.

\begin{table}[!t]
  \centering
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{ccc}
    \hline
    moment & central value & standard deviation \\
    \hline
  $\moment{0}{0}{0}$   & $+3.7454$  &  $0.0023$  \\
  $\moment{1}{0}{0}$   & $-2.0982$  &  $0.0084$  \\
  $\moment{2}{0}{0}$   & $-1.9116$  &  $0.0126$  \\
  $\moment{3}{0}{0}$   & $-0.0317$  &  $0.0151$  \\
  $\moment{4}{0}{0}$   & $+0.1146$  &  $0.0175$  \\
  $\moment{5}{0}{0}$   & $+0.1384$  &  $0.0193$  \\
  $\moment{0}{2}{0}$   & $+0.2820$  &  $0.0066$  \\
  $\moment{0}{2}{2}$   & $+0.0612$  &  $0.0058$  \\
  $\moment{0}{4}{0}$   & $+0.0864$  &  $0.0066$  \\
  $\moment{1}{2}{0}$   & $-0.1900$  &  $0.0115$  \\
  $\moment{1}{4}{0}$   & $-0.0720$  &  $0.0118$  \\
  $\moment{2}{2}{0}$   & $-0.1315$  &  $0.0161$  \\
  $\moment{2}{2}{2}$   & $-0.0674$  &  $0.0117$  \\
  \hline
  \end{tabular}
  \caption{Efficiency moments of \BsJpsiKst.}
   \label{eff_moms_table}
\end{table}

In order for the efficiency moments $c^i_{jk}$ to be computed a definition of the efficiency is necessary. Note that this computation relies on
simulated data where all the generating conditions are known. The efficiency is defined as the ratio of two angular \pdfs, namely
\Pobs and \Pgen. The first is the angular \pdf that the simulated data follow after all stages of selection, whereas
the latter is the angular \pdf with which the simulated data has been generated.
It follows that the efficiency is defined as:

\begin{equation}
  \centering
  \Pobs = \epsilon(\Omega) \Pgen \quad \Rightarrow \quad \epsilon(\Omega) \equiv \frac{\Pobs}{\Pgen}.
  \label{eff_def}
\end{equation}

\noindent Computing the efficiency moments is done by projecting the efficiency as defined in \equref{eff_def}
on the orthogonal $PY$ basis. This projection is shown in the following equation:

\begin{align}
  \centering
   c^i_{jk}  \equiv & \parenthesis{j + \frac{1}{2}} \; \int \; d\Omega \; \effbase \; \epsilon(\Omega) \nonumber \\
                 =  & \parenthesis{j + \frac{1}{2}} \; \int \; d\Omega \; \Pobs \; \frac{\effbase}{\Pgen}.
  \label{eff_moms_def}
\end{align}

\noindent The factor $j+\frac{1}{2}$ is used to make it such that the associated Legendre polynomials form an
orthonormal basis; implying that the integral of the product of two associated Legendre polynomials is equal
to the {\it Kronecker delta} symbol. The later fact is required to properly normalize the efficiency moments.
The final step in the calculation of the efficiency moments is the computation of the integral in \equref{eff_moms_def}.
This is done by means of simulated data and the integral is computed following the concept of Monte Carlo integration. This implies
that the integral in \equref{eff_moms_def} can be estimated by a sum over the simulated data (which they have passed through the exact
same selection steps as data) as:

\begin{equation}
\centering
  E\left[ \int \; d\Omega \; \effbase \frac{\Pobs}{\Pgen} \right] = \frac{1}{\Nobs} \sum_e^{\Nobs} \frac{\effbase}{\Pgen}.
  \label{eff_moms_calc}
\end{equation}

\noindent Combining \equref{eff_moms_def} and \equref{eff_moms_calc} the final expression for computing the efficiency moments is shown
in \equref{eff_moms_calc_final} and the result of the computations can be found it table \tabref{eff_moms_table}

\begin{equation}
\centering
 c^i_{jk} \equiv (j + \frac{1}{2})  \frac{1}{\Nobs} \sum_e^{\Nobs} \frac{\effbase}{\Pgen}.
  \label{eff_moms_calc_final}
\end{equation}

\noindent Acceptance effects in the $\cos\thetamu$ projection are less pronounced compared to the one $\cos\thetaK$.
This can be deduced from \figref{angAcc_ctl} as well as from the values of moments like $\moment{0}{j}{k}$
compared to the values of $\moment{1}{0}{0}$ and $\moment{2}{0}{0}$. Lastly, the efficiency moments are
correlated and the corresponding correlation matrix can be found in \tabref{eff_moms_corr}.

\subsubsection{Choice of efficiency moments}
The choice of efficiency moments has to do with the structure of the acceptance at $\cos\thetaK=1$. At that point the acceptance goes to zero
which is not a problem by itself. However, within the parametrization of the acceptance function, \equref{eff_func} may become negative.
In other words the method of efficiency moments does not guarantee that the acceptance function is a positive definite quantity.
Note that this is an artifact of the parametrization. The problem is mathematical in nature and there is no standard solution (known
to the author when these lines were written). The approach followed to solve this problem has two steps: First a constraint on the
efficiency function, \equref{eff_func}, is introduced to force it to be positive definite and second, a fit to the efficiency
moments is performed to optimize the acceptance shape description. The result is a hybrid acceptance function that is by
construction positive definite.

Before laying out the formulas behind the above-mentioned steps it is useful to visualize the problem caused by the parametrization, see \figref{angAcc_nom}
and the corresponding caption. Subsequently, the most natural thing to do before making any effort to force the value of \equref{eff_func}
positive at $\cos\thetaK=1$ is to make the best possible choice of efficiency moments. The moments are chosen such that the efficiency function becomes negative
at the largest possible value of $\cos\thetaK$. In other words the crossing point of the red curve with the horizontal axis in \figref{angAcc_nom},
has to be as close to $\cos\thetaK=1$ as possible.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_helcosthetaK_neg_all_raw_zoom}
    \scalebox{1.15}{\input{Figures/Chapter4/eff_helcosthetaK_neg_all_raw_zoom}}
    \caption{}
    \label{angAcc_nom}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \raggedleft
    \tikzsetnextfilename{eff_helcosthetaK_neg_all_constr_fit_zoom}
    \scalebox{1.15}{\input{Figures/Chapter4/eff_helcosthetaK_neg_all_constr_fit_zoom}}
    \caption{}
    \label{angAcc_constr_fit}
  \end{subfigure}
  %% \begin{subfigure}{0.5\textwidth}
  %%   \tikzsetnextfilename{eff_helcosthetaK_neg_all_constr_zoom}
  %%   \scalebox{1.3}{\input{Figures/Chapter4/eff_helcosthetaK_neg_all_constr_zoom}}
  %%   \caption{}
  %%   \label{angAcc_constr}
  %% \end{subfigure}
  \caption{\pdf projection of $\cos\thetaK$ corrected with the angular efficiency function before (left) and after (right)
           constraining its value at $\cos\thetaK=1$, shown as the red curve. The black points show the $\cos\thetaK$
           distribution in the simulated sample. Zooming close to $\cos\thetaK=1$ clearly shows the problematic region.}
  \label{angAcc_constr}
\end{figure}

It is actually not trivial to find a good choice of efficiency moments. Two things are relevant when trying to describe a
distribution with orthogonal functions like $P$ and $Y$. One is the shape of the orthogonal function itself and two the sign and size of the calculated moment.
For example the efficiency term $\moment{1}{0}{0}P_1Y_{00}$ is necessary to describe the drop of efficiency in $\cos\thetaK$ but the size of $\moment{1}{0}{0}$
is too large making the total efficiency function negative. Thus one could add the term $P_3Y_{00}\moment{3}{0}{0}$ where $\moment{3}{0}{0}$ is positive
(see \tabref{eff_moms_table} ) to counter the large negative value of $\moment{1}{0}{0}$ but unfortunately it is not enough. Things get more complicated
when trying to choose efficiency moments that affect the acceptance shape in all of its three dimensions at the same time.

Having chosen the best possible set of moments the efficiency function has to be constrained such that the condition,

\begin{equation}
  \centering
  \epsilon(\cos\thetaK = 1, \cos\thetamu, \phihel) = 0,
  \label{eff_func_constr}
\end{equation}

\noindent is satisfied. It turns out that this condition can be easily satisfied if the basis that the
efficiency function is decomposed, see \equref{eff_func}, is modified as:

\begin{align}
  \centering
   \effbase \to \parenthesis{\effbase}^\prime = \left[\legendre{i}{0}-P_i^0(1)\right] \spharm{j}{k},
  \label{eff_basis_transform}
  \end{align}

\noindent resulting in the following efficiency function:

\begin{align}
    \centering
  \epsilon(\Omega) = \sum_{ijk} \; \moment{i}{j}{k} \; \left[\legendre{i}{0}-P_i^0(1)\right] \; \spharm{j}{k}.
  \label{eff_func_new}
\end{align}

\noindent Note that the subscript $i$ in $P_i^0(1)$ is irrelevant since $P_i^0(1)=1$ for any value of $i$.
The result of the above constraint is shown in \figref{angAcc_constr_fit}, where it can be seen that
the acceptance projection on $\cos\thetaK=1$ is not negative anymore. In addition it has also been checked
whether the acceptance is negative in 2D and 3D, since it is possible for a 2D projection of the acceptance
to take negative values whilst the 1D projections are positive. Two dimensional projection of the constrained
acceptance can be seen in \figref{eff2D}.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \raggedright
    \includegraphics[width=\textwidth]{Figures/Chapter4/canv_cosThK_cosThL_Sim08_3fb_hel_negKaons_all.pdf}
    \caption{}
    \label{eff2D_kl}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \raggedleft
    \includegraphics[width=\textwidth]{Figures/Chapter4/canv_cosThK_phi_Sim08_3fb_hel_negKaons_all.pdf}
    \caption{}
    \label{eff2D_kp}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \raggedright
    \includegraphics[width=\textwidth]{Figures/Chapter4/canv_cosThL_phi_Sim08_3fb_hel_negKaons_all.pdf}
    \caption{}
    \label{eff2D_lp}
  \end{subfigure}
\caption{Two dimensional efficiency projections of the constrained efficiency function.
         The equivalent plots for \BsbarJpsiKst are indistinguishable by eye. The scale of the $y$-axis is arbitrary.}
    \label{eff2D}
\end{figure}

Constraining the acceptance in the manner described above comes with a small penalty: the shape of the 1D acceptance
projections is slightly distorted. In order to reduce this distortion and describe better the acceptance shape an additional step is implemented.
As previously mentioned, the acceptance function of \equref{eff_func_new} is fitted to the simulated data
where the efficiency moments are allowed to vary from their measured values, of \tabref{eff_moms_table}.
This feature is implemented by a multivariate Gaussian constraint where correlations between efficiency moments are taken into account.
The fitting \pdf is shown in \equref{mvm_constr} and it consists of the \pdf with which the simulated
data were generated, multiplied with the efficiency function \eqref{eff_func_new} times the multivariate Gaussian constraint.
The physics parameters used to generate the simulation sample are fixed and only the efficiency moments are allowed to vary.
The multivariate Gaussian function $G(\vec{\bf{c}})$, used to constrain the efficiency moments is shown in \equref{mvm_constr_gauss}.

\begin{equation}
  \centering
  \mathcal{P}= \Pgen \times\epsilon(\Omega;\vec{\bf c})  \times G(\vec{\bf{c}}),
  \label{mvm_constr}
\end{equation}

\noindent with

\begin{equation}
\centering
  G(\vec{\bf{c}}) = \frac{1}{\sqrt{(2\pi)^k}|C|} \; e^{-\frac{1}{2}(  \vec{\bf{c}} - <{\bf{c}}>  )^{\text{T}} C^{-1} (\vec{\bf{c}} - <{\bf{c}}> ) },
\label{mvm_constr_gauss}
\end{equation}

\noindent where $\vec{\bf c}$ represents the estimated efficiency moments and $<\vec{\bf c}>$ are the efficiency moments
of \tabref{eff_moms_table}. $C$ and $|C|$ are the covariance matrix of the efficiency moments and its determinant respectively.
Lastly, $k$ is the number of efficiency moments present in \equref{eff_func_new}.

\subsubsection{Alternative parametrization}
As mentioned before there is at least one more way to parameterize the angular acceptance, namely the \emph{normalization weights}.
The main difference between this approach and the method adopted in this analysis is that essentially the normalization weights use the angular functions
of \tabref{ang_distr} as a basis to project the efficiency of \equref{eff_def}, instead of the orthogonal basis $a_i^{jk}$ of \equref{eff_func}.
Looking at \equref{norm_weights_pdf} it is helpful to realize how the normalization weights, $\xi_a$, are introduced into the fitting \pdf.
One can see that they effectively do not multiply the angular \pdf directly. Instead the normalization weights modify the relative contributions
between the angular functions $h_n$, in the normalization integral of the fitting \pdf. The normalization weights are also calculated following the concept of Monte Carlo integration
similarly to the case of efficiency moments.

\begin{equation}
  \mathcal{P} \propto \frac{\sum_n h_n(\Omega)}{\sum_n \int d\Omega \; \epsilon(\Omega) \; h_n(\Omega)}, \;\;\;\;\text{where} \int d\Omega \; \epsilon(\Omega) \; h_n(\Omega) \equiv \xi_a
  \label{norm_weights_pdf}
\end{equation}

The advantages of this method is that it is by construction immune from any issue with localized negative efficiency values:
the acceptance shape is not parameterized at all. The disadvantage on the other hand is that directly
plotting the fitting \pdf becomes impossible when using normalization weights. This is because the normalization integral
of the fitting \pdf is modified in a non-trivial way and other methods need to be implemented in order to visualize the \pdf.
Lastly the two methods can yield identical values on the
fitted parameters by mapping the normalization weights to efficiency moments. This can be done if one solves the normalization integral,
$\int d\Omega\;\Pgen\times\epsilon(\Omega)$ of the \pdf of \tabref{ang_distr} and the efficiency function in \equref{eff_func},
then the mapping of $\moment{i}{j}{k} \rightarrow \xi_a$ follows naturally by exploiting the orthogonality of $P$ and $Y$.
However, the above-mentioned mapping is not unique and not always invertible. It depends on the choice of the particular
efficiency moments. More details on the normalization weights approach can be found in \cite{jeroenThesis} and \cite{tristanThesis}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Acceptance Corrections}
\label{Accceptance_Corrections}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The angular acceptance described in section \secref{Accceptance} is determined with simulated \BsJpsiKst events.
Thus the acceptance determination can be trusted only if the simulation accurately describes the detector as well as the
physical amplitudes of the \BsJpsiKst decay. Specifically real and simulated data differences in the momentum distributions
of the final state particles may reflect a different acceptance in real compared to simulated data.
Such differences are at a few percent level between real and simulated data.
On the other hand, differences between data and simulation could be also attributed to
differences in the underlying physical parameter values generating the simulated data compared to these
present in data. For example, the presence of S-wave in the data (and its absence on simulated data)
can cause a difference in the observed kaon momentum spectrum even though the angular acceptance may be perfectly simulated.
Both of the above-mentioned effects have an impact on the decay angles distribution since the helicity angles are functions
of the momenta of the final state particles.

In order to overcome the problem of simulation imperfections, the simulated sample is weighted using an iterative procedure.
At each step of the weighting procedure the simulated data are corrected for the current best estimate of the physics
parameters and the two dimensional $(p_{\kaon},p_{\pion})$ momentum distribution.
The efficiency moments are re-evaluated using the weighted simulated sample and the fit to the data is repeated.
This changes the best estimate of the parameters of interest. This procedure is repeated until these parameters
converge. The full procedure by steps can be summarized as:

\begin{figure}[!t]
  \centering
  \begin{subfigure}{0.49\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_mc_helcosthetaK_allKaons_binall_rew}
    \scalebox{1.13}{\input{Figures/Chapter4/eff_mc_helcosthetaK_allKaons_binall_rew}}
    \caption{}
    \label{angAccCor_ctk}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.49\textwidth}
    \raggedleft
    \tikzsetnextfilename{eff_mc_helcosthetaL_allKaons_binall_rew}
    \scalebox{1.13}{\input{Figures/Chapter4/eff_mc_helcosthetaL_allKaons_binall_rew}}
    \caption{}
    \label{angAccCorr_ctl}
  \end{subfigure}
  \vspace*{0.02\textwidth}
  \begin{subfigure}{0.49\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_mc_helphi_allKaons_binall_rew}
    \scalebox{1.13}{\input{Figures/Chapter4/eff_mc_helphi_allKaons_binall_rew}}
    \caption{}
    \label{angAccCorr_phi}
  \end{subfigure}
  \caption{Angular acceptance shape from simulated data before (black points) and after (red points) acceptance corrections.
           Plots are made in the same way as in \figref{angAcc_all}.}
  \label{angAggCorrections}
\end{figure}


\begin{enumerate}
\item Calculate an initial set of efficiency moments using uncorrected \BsJpsiKst simulated data.
\item Perform a fit on the \BsJpsiKst data using the initial efficiency moments, and obtain the first estimate of the physical parameters.
\item Weight each candidate in the simulated data for the difference between the angular \pdf obtained from the previous fit and the angular
      \pdf used to generate the simulated data. This essentially means that the underlying physics of the weighted simulated data corresponds
      to the estimated physics parameters obtained in the previous step.
\item Compare the 2D $(p_\kaon,p_\pion)$ momentum distribution between the physics weighted simulated data of the previous step with the
      data, and weigh again each simulated candidate according to the difference.
\item Re-estimate the efficiency moments using the physics and momentum corrected \BsJpsiKst simulated data and repeat the fit to the \BsJpsiKst data.
\item Go back to step 4 and repeat until the change in the parameters of interest is negligible.
\end{enumerate}

\begin{table}[!h]
  \center
  \begin{tabular}{c c c}
    \hline
     variables & range & $\# \text{intervals}$ \\
     %\multicolumn{2}{c}{range}   &  vs        \\
    \hline
    $p_\kaon$    &  $[0,140] \; \gevc$  & 10      \\
    $p_\pion$    &  $[0,60]  \; \gevc$  & 10      \\
    \hline
  \end{tabular}
  \caption{\small Weighting variable intervals.}
  \label{angAccBinning}
\end{table}

The $(p_\kaon,p_\pion)$ weighting of the simulated data sample is done using 2D histograms, following the intervals defined in \tabref{angAccBinning}.
At least 6 iterations are necessary to achieve convergence. Detailed evolution of the parameters of interest after each iteration are shown in
\tabref{pars_convergence}. The central values of the parameters of interest do not change significantly implying that the overall effect of the
acceptance corrections is small. \figref{angAggCorrections} shows the shape of the acceptance before and after corrections.
This is also supported by the effect of these corrections on the parameters of interest which are shown in \tabref{pars_convergence}.

\begin{table}[t]
\centering
\footnotesize
\begin{tabular}{ c c c c c c c c c | c}
  \hline
  Iteration          &       $1$       &       $2$       &       $3$       &       $4$       &       $5$       &       $6$  & total\\
  \hline
  $\Acp{0}$                       &  $-0.00$  &  $-0.03$  &  $+0.03$  &  $+0.00$  &  $-0.00$  &  $-0.00$  &  $+0.00$    \\
  $\Acp{\parallel}$               &  $+0.13$  &  $+0.04$  &  $-0.09$  &  $-0.04$  &  $-0.02$  &  $-0.01$  &  $+0.01$    \\
  $\Acp{\perp}$                   &  $-0.19$  &  $+0.15$  &  $+0.02$  &  $+0.01$  &  $+0.00$  &  $+0.00$  &  $-0.01$    \\
  $\Acp{\text{S}}$                &  $-0.01$  &  $-0.17$  &  $+0.09$  &  $+0.06$  &  $+0.03$  &  $+0.01$  &  $+0.01$    \\
  \hline
  $\fP{0}$                        &  $-1.15$  &  $+0.96$  &  $+0.19$  &  $+0.00$  &  $-0.02$  &  $-0.01$  &  $-0.03$    \\
  $\fP{\parallel}$                &  $-0.05$  &  $-0.06$  &  $+0.03$  &  $+0.04$  &  $+0.02$  &  $+0.01$  &  $-0.01$    \\
  $\ampPhase{\parallel}$          &  $-0.37$  &  $+0.23$  &  $+0.09$  &  $+0.03$  &  $+0.01$  &  $+0.0 $  &  $-0.01$    \\
  $\ampPhase{\perp}$              &  $-0.57$  &  $+0.28$  &  $+0.16$  &  $+0.07$  &  $+0.03$  &  $+0.01$  &  $-0.02$    \\
  \hline
  $\fS{1}$                        &  $+0.86$  &  $-0.66$  &  $-0.32$  &  $-0.12$  &  $-0.05$  &  $-0.02$  &  $-0.31$    \\
  $\fS{2}$                        &  $+0.84$  &  $-0.27$  &  $-0.18$  &  $-0.09$  &  $-0.05$  &  $-0.02$  &  $+0.23$    \\
  $\fS{3}$                        &  $+0.00$  &  $-0.02$  &  $-0.00$  &  $+0.01$  &  $+0.02$  &  $+0.01$  &  $+0.02$    \\
  $\fS{4}$                        &  $+0.47$  &  $-0.21$  &  $-0.14$  &  $-0.06$  &  $-0.04$  &  $-0.02$  &  $-0.00$    \\
  $\deltaS{1}$                    &  $-2.08$  &  $+0.90$  &  $+0.66$  &  $+0.32$  &  $+0.13$  &  $+0.04$  &  $-0.03$    \\
  $\deltaS{2}$                    &  $+0.13$  &  $-0.05$  &  $-0.02$  &  $-0.03$  &  $-0.01$  &  $-0.01$  &  $+0.01$    \\
  $\deltaS{3}$                    &  $-0.90$  &  $+0.48$  &  $+0.19$  &  $+0.08$  &  $+0.04$  &  $+0.03$  &  $-0.08$    \\
  $\deltaS{4}$                    &  $-2.43$  &  $+1.10$  &  $+0.53$  &  $+0.24$  &  $+0.13$  &  $+0.07$  &  $-0.36$    \\
  \hline
\end{tabular}
\caption{Parameters of interest after each iteration. The amount of change is expressed as a fraction of one standard deviation.
         Differences get progressively smaller, implying convergence.}
\label{pars_convergence}
\end{table}

Lastly, the acceptance can be floated in the angular fit to the data in order to assign a systematic uncertainty, see \secref{systAngAcc}.
This feature makes, in hindsight, the acceptance correction procedure unnecessary.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\Kpi Invariant Mass}
\label{Kpi_Invariant_mass}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The dependence of the \BJpsiKpi decay amplitude on \mkpi as introduced in \equref{ang_terms} is treated in a special way.
The $\mKpiAmp$ functions are not implemented, but instead they are integrated over in four intervals. The choice of this strategy
is good enough given the fact that the \mkpi region relevant for this analysis is dominated by the $\Kstar$ \pwave,
while the \swave component is small. As a result the development of a full model for both the \pwave and \swave, which is not the
first priority in the current analysis, can be avoided. Despite the \mkpi integration there is still some residual dependence left.
It originates from integrals like the one in the following equation:

\begin{equation}
  \label{spIntegrals}
  \int d\mkpi \; \Phi \; \mKpiAmp^* \mKpiAmp[m],
\end{equation}

\noindent where $\mKpiAmp[n,m]$ run in the same way as in \equref{ang_terms}, and $\Phi$ is a standard
phase space factor:

\begin{equation}
  \centering
  \Phi = \frac{\lambda(m_\mmu,m_\kaon,m_\pion) \lambda(m_{\Bs},m_\jpsi,m_\mmu)}{ 4 m_\mmu^2},
  \label{csp_ph_sp_factor}
\end{equation}

\noindent with

\begin{equation}
  \centering
  \lambda(m_1,m_2,m_3) = \frac{m_1^2 - 2m_1^2(m_2^2 + m_3^2) + m_2^2 + m_3^2 - 2m_2^2m_3^2 } {m_1^2} \nonumber
  \label{csp_ph_sp_factor_def}
\end{equation}

Integrals like \equref{spIntegrals} eventually manifest themselves only in the \spwave interference
terms of \tabref{eff_moms_table}. Note that the diagonal $m=n$ integrals are by construction equal to 1.
These integrals can be written as:

\begin{equation}
  \centering
  \label{csp_def}
  \frac{\int_{\mkpi^-}^{\mkpi^+} d\mkpi \; \Phi \; s^* \times p} {\int_{\mkpi^-}^{\mkpi^+} d\mkpi \; \Phi \; |s|^2 \; \int_{\mkpi^-}^{\mkpi^+} d\mkpi \; \Phi |p|^2} = \CSP \; e^{-i\ThetaSP},
\end{equation}

\noindent where $s$ and $p$ stand for the \swave and \pwave line-shapes respectively. Evaluating these complex valued integrals yield
the so called $\CSP$ factors which are inserted in the angular functions of \tabref{ang_distr}. Particularly, the real part
is inserted as a multiplicative factor in all of the \spwave interference terms, for example $\ReAmp{0}{S} \to \ReAmp{0}{S} \cdot \CSP\cdot\cos\parenthesis{\ampPhase{0}+\deltaS{}+\ThetaSP}$.
The imaginary part, $\ThetaSP$, is absorbed in the overall phase of the \spwave interference term.
Varying either $\CSP$ or $\ThetaSP$ in the fit is not preferred due to high correlations between the decay amplitudes.
Instead it would be better to extend the angular fit so that the \mkpi dependence is modeled directly via the $\mKpiAmp$
terms of \equref{ang_terms}. The above-mentioned line-shapes, $s$ and $p$ that are necessary
to compute the $\CSP$ factors are a combination of a \KstENT and \KstOFOZ for the \pwave, as in \cite{PhysRevD.11.3165}.
Whereas for the \swave a LASS parametrization \cite{Aston1988493} is used, consisting of a linear combination of the \KstOFTZ resonance with
a non-resonant term, coming from elastic scattering.

\subsubsection{Background subtracted \mkpi distribution}

\begin{figure}[!t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{eff_corrected_raw_mdau2}
    \raggedright
    \scalebox{0.56}{\input{Figures/Chapter4/eff_corrected_raw_mdau2}}
    \caption{}
    \label{mkpiPlot_raw}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \raggedleft
    \tikzsetnextfilename{eff_corrected_eff_mdau2}
    \scalebox{0.56}{\input{Figures/Chapter4/eff_corrected_eff_mdau2}}
    \caption{}
    \label{mkpiPlot_eff}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \raggedright
    \tikzsetnextfilename{eff_corrected_raw_mdau1}
    \scalebox{0.56}{\input{Figures/Chapter4/eff_corrected_raw_mdau1}}
    \caption{}
    \label{jpsiPlot}
  \end{subfigure}
\caption{Comparison of the intermediate state particles mass distributions between \Bs and \Bd.
         The plots are background subtracted. Top row shows the \mkpi distribution before (left)
         and after (right) correcting for angular acceptance effects. The \jpsi mass background subtracted
         distribution is shown at the bottom. It was checked that the acceptance correction has negligible
         effects on the shapes of the \jpsi mass distributions.}
\end{figure}

While the \Bs and \Bd background subtracted muon pair mass background subtracted, $\mmumu$, have very similar shapes, the \mkpi spectra exhibit different shapes.
Indeed, the \Bs \mkpi \sPlot of \figref{mkpiPlot_raw} seems to be slightly distorted compared to the one of \Bd \mkpi.
Since there is no \aprior reason why the \Kstarz \pwave
should have different shape between \BsJpsiKst and \BdJpsiKst; This could indicate the presence of interference between
the $\kaon\pi$ \swave and the \Kstarz, which may be stronger in the \Bs decays compared to the \Bd ones. In order
to check the validity of this hypothesis, two additional studies are performed. First it was checked that the non-resonant
background treatment propagated to the \sWeights was not responsible for this behavior. Indeed, no significant difference
between the \Bs \mkpi spectrum using \sWeights computed with and without simulated data injection was found. Second, the \mkpi
is corrected for angular acceptance effects, by weighting each candidate with the inverse of the acceptance function of \equref{eff_func_new}.
This way the interference between the $\kaon\pi$ \swave and the \Kstarz \pwave vanishes, since
for a perfect acceptance the interference terms in \tabref{ang_terms}, integrated over all angles, evaluate to zero.
This is demonstrated in \figref{mkpiPlot_eff}. The \Bs \mkpi distribution is closer to the one of the \Bd after applying
the efficiency correction. This is a clear indication of the presence of stronger interference in the \Bs case compared to the \Bd.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Production and Detection Asymmetries}
\label{experimentalAssym}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The nature of the current analysis is such that it is affected by asymmetries related to experimental effects.
Particularly, the difference between the number of observed \BsJpsiKst and \BsbarJpsiKst decays is related to the
main parameters of interest, introduced in \secref{cp_assymetries_and_total_decay_rate}. These parameters essentially
quantify the direct \CP asymmetry between the previous decays.
Considering now the case where collisions at the \lhc would favor the \BsJpsiKst decay over its \CP conjugate, \BsbarJpsiKst;
or that the detector might have different efficiency for positive and negative kaons (or pions),
then the observed $\Acp{}$ will be biased by these experimental effects. In fact it happens so that both of these effects
are present. The first one, where the creation of a \Bs or \Bsb is favoured is labelled as  production asymmetry, $\Aprod$,
whereas the second effect is labelled as detection asymmetry, $\Adet$. The production and detection
asymmetries are defined in the following equation:

\begin{equation}
\centering
         \Aprod = \frac{ \crosSec{\Bsb} - \crosSec{\Bs} }{\crosSec{\Bsb} + \crosSec{\Bs}}
  \quad  \Adet  = \frac{ \effDet{\Kstarz} - \effDet{\Kstarzb} }{\effDet{\Kstarz} + \effDet{\Kstarzb}},
\label{exp_asym_def}
\end{equation}

\noindent where $\sigma$ is the production cross section of either \Bs or \Bb , whereas \edet is the efficiency
of detecting \Bs(\Bsb) decays into the final state which is a $\jpsi\Kstarzb$($\jpsi\Kstarz$), see also \secref{cp_assymetries_and_total_decay_rate}.
Both of the production and detection asymmetries have to be estimated so that the experimentally measured asymmetry, $\Acp{\rm raw}$,
defined in \equref{acp_mes}, can be corrected for as follows:

\begin{equation}
\centering
\Acp\;(\BsJpsiKst) = \Acp{\rm raw} +\Adet - \kappa\Aprod,
\label{acp_corrected}
\end{equation}

\noindent where the corrected asymmetry \Acp\;(\BsJpsiKst) is related to the \BsJpsiKst decay
amplitudes, defined in \equref{ang_terms}, as:

\begin{align}
\centering
  \Acp\;(\BsJpsiKst&) = \nonumber \\
  = &\frac{\totAmp{\BsbarJpsiKst} - \totAmp{\BsJpsiKst}}{\totAmp{\BsbarJpsiKst} + \totAmp{\BsJpsiKst}}.
\label{acp_corrected_amps}
\end{align}

\noindent The factor $\kappa$ of \equref{acp_corrected} accounts for the dilution due to $\Bs-\Bsb$
oscillations \cite{LHCb-PAPER-2013-018} and is:

\begin{equation}
  \centering
 \kappa = \frac{\int_0^\infty  e^{-\Gamma_s t} \cos \!\left( \Delta m_s t \right ) \varepsilon(t)\mathrm{d}t}{\int_0^\infty  e^{-\Gamma_s t} \cosh \left( \frac{\Delta \Gamma_s}{2} t \right ) \varepsilon(t)\mathrm{d}t}.
\label{kappa}
\end{equation}

\noindent It evaluates to $0.06\%$, which implies that the $\Bs-\Bsb$ oscillation frequency is large compared to the
average lifetime, $\Gamma_s$. As a result the production asymmetry is nearly completely washed out.
The quantities $\Delta\Gamma_s$ and $\Delta m_s$ have been introduced in \secref{Phenomenology},
while the decay time efficiency function $\varepsilon(t)$ is estimated on background subtracted \BsJpsiKst
data and parameterized as in \cite{LHCb-PAPER-2014-053}.

% with a the function $\varepsilon(t)= \frac{[1+\beta(t-t_0)][a(t-t0)]^n}{1+[a(t-t_0)]^n}$ found

Using the result from the dedicated \lhcb measurement of the production asymmetry \cite{LHCb-PAPER-2014-042}
and replacing the yield fractions in intervals of \Bs momentum of Table 3 in the same reference with the background
subtracted \BsJpsiKst ones of the current analysis, one gets the following production asymmetry:

\begin{equation}
    \centering
    \Aprod = (-1.64 \pm 2.28 \stat \pm 0.55 \syst).
  \label{prod_assym}
\end{equation}

\noindent The detection asymmetry is computed starting from the \lhcb study of the detection asymmetry
in \cite{LHCb-PAPER-2014-013} and weighting the kaon momentum distribution to much the observed
distribution in \BsJpsiKst data. The result is:

\begin{equation}
    \centering
    \Adet  = (-1.086 \pm 0.531 \stat).
  \label{det_assym}
\end{equation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Likelihood fit and Total Decay Rate}
\label{Total_Decay_Rate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Nearly all the necessary ingredients to fit for the parameters of interest are covered in the previous subsections.
However there are a few important details remaining. The current subsection addresses the
implications arising from the necessary splitting of the data in slices and the impact of this in the adopted
fitting strategy. Lastly but most importantly the issue of defining
the polarization dependant \CP asymmetries, \Acp{k}, as free parameters in the angular fit and how this becomes
relevant in the normalization of the \pdfs involved is discussed in the last part of the current subsection.

\subsubsection{Simultaneous likelihood fit}
\label{Simutaneous_Likelihood_fit}
There are several reasons as to why the data are divided into sub-samples.
For example, the special treatment of the \mkpi dependence, as described in \secref{Kpi_Invariant_mass}
requires that the data is split in four \mkpi intervals. This implies that for each data category, a
corresponding component \pdf must be defined. Some parameters of interest differ between the categories
while some others are shared. In order to avoid performing four independent fits and subsequently averaging the common parameters
of interest, a simultaneous fit is implemented. In a simultaneous fit each component \pdf is assigned to a certain part of the data
such that the corresponding component \pdf is invoked when the total \pdf is evaluated. The current section summarizes
all the categories that the data is split into and the implications arising from this. Lastly a brief insight in some aspects
of the likelihood parameter estimation method are included.

The first data category is related to the fact that the angular \pdf terms of \tabref{ang_distr} cannot describe both \BsJpsiKst
and \BsbarJpsiKst. There is a relative minus sign difference in the imaginary terms originating from complex conjugating the decay
amplitude of \BsJpsiKst. For reasons explain in \secref{penguin_formalism} the \BsJpsiKst decays always have a negative kaon in
the final state and \viceversa in the case of \BsbarJpsiKst decays. Thus the data must be split according to the charge of
the kaon. Furthermore, as can be seen in \tabref{moms_comp_signs} the agreement between the \BsJpsiKst and \BsbarJpsiKst samples
is sufficient for them to be averaged into one set of efficiency moments. However, the angular acceptance as described in \secref{Accceptance}
is calculated separately for these two samples. This is done to avoid involving the $\Acp{i}$ parameters of interest
in the estimation of the efficiency moments, which significantly simplifies the necessary computation.
Note that the $\Acp{i}$ parameters are used to average the \BsJpsiKst and \BsbarJpsiKst decay amplitudes into one parameter,
more details in \secref{cp_assymetries_and_total_decay_rate}.

\begin{table}[t]
\centering
\begin{tabular}{c c c c c}
  \hline
              & interval 1 & interval 2 & interval 3 & interval 4\\
  \hline
  \mkpi range & $ [826,861) $ & $ [861,896) $ & $ [896,931) $ & $ [931,966] $ \\
  \CSP factor & $ 0.9681 $    & $ 0.9312 $    & $ 0.9519 $    & $ 0.9880 $ \\  \hline
\end{tabular}
\caption{Definitions of \mkpi intervals and the corresponding \CSP factor values.}
\label{csp_vals}
\end{table}

The next observable used to split the data is already mentioned in \secref{Kpi_Invariant_mass} that dealt with the \mkpi dependence.
There are four \mkpi intervals defining four more categories in the data. Furthermore, and contrary to the above-mentioned data category, there
are parameters of interest that are different in each \mkpi interval. Namely the \swave fraction $\fS{}$ and phase $\deltaS{}$.
In addition, the \CSP factors of \secref{Kpi_Invariant_mass} need to be calculated and inserted separately for each component \pdf resulting in
\tabref{csp_vals}, where the \CSP factors are shown for each \mkpi interval. The acceptance is also split in the \mkpi category
since it was found to vary significantly between \mkpi intervals, see \tabref{moms_final_neg} and \tabref{moms_final_pos}.
The \mkpi intervals chosen are shown in \tabref{csp_vals}.

The data categories described above result in a simultaneous fit consisting of eight categories.
A single angular acceptance is computed form the combined 2011 and 2012 data samples on grounds of
tables \tabref{moms_comp_periods_pos} and \tabref{moms_comp_periods_neg}.

Having addressed the simultaneous nature of the fit it is interesting to provide an insight on
the connection between a \pdf and the likelihood estimation of the parameters of interest.
Thus, starting from any \pdf $\mathcal{P}$ a likelihood function can be built as:

\begin{equation}
  \centering
L(\vec{p};\vec{x}) = \prod_e^n \mathcal{P}(\vec{x};\vec{p}).
\label{likelihood}
\end{equation}

\noindent By definition the likelihood function is the product of probabilities of every candidate according to the
 given \pdf. Note that, contrary to the \pdf, the likelihood is a function of the parameters given all the candidates in the data.
It is useful to realize that at the maximum of the likelihood function one gets the best estimate for the parameters of
interest, $\vec{p}$, given the data, $\vec{x}$. The inverse of the covariance matrix for the estimated parameters is given
by the negative second derivative of the log likelihood at the maximum,

\begin{equation}
  \centering
\left( V^{-1} \right)_{ij} = - \left. \frac{\partial^2\ln L}{\partial p_1 \partial p_2} \right|_{ \vec{p}_{\rm\bf max}}.
\label{covariance}
\end{equation}

Regarding the concept of the extended likelihood: In \equref{likelihood} the number of candidates is fixed.
However, it is possible to extend the previous equation such that the expected number of candidates shows up as a parameter in the likelihood
function and can thus be estimated. This is useful in cases where the \pdf consists of a sum over two species, such as signal and background,
or if the expected number of candidates depends on the parameters of interest $\vec{p}$. For the current analysis, the latter is
exploited in order to estimate the $\Acp{i}$ asymmetries in the fit. The \pdf is extended by multiplying it with the Poisson
probability to observe $n$ events when expecting $\expEvnts$ candidates, see \equref{extlikelihood}.
The expected number of candidates $\expEvnts$ depends on the
parameters of interest which increases the statistical uncertainties. This is because the likelihood has more freedom
as the number of parameters increases and thus the shape of the likelihood becomes less steep leading to larger statistical
uncertainty.

\begin{equation}
  \centering
L(\vec{p};\vec{x}) = P(n;\expEvnts) \; \prod_e^n \mathcal{P}(\vec{x};\vec{p}),
\label{extlikelihood}
\end{equation}

For purely practical reasons one would typically choose to minimize the negative logarithm of the likelihood, which after some simple
algebra and using the well known expression of the Poisson distribution results in:

\begin{align}
  \centering
  -\nll &= -\ln\left( \frac{\expEvnts}{n\,!} e^{-\expEvnts } \right) - \ln\left( \prod_e^n \mathcal{P}(\vec{x};\vec{p}) \right)  \nonumber \\
        &= - n\ln(\expEvnts) + \expEvnts  + \ln n! - \sum_e^n \ln\parenthesis{\mathcal{P}(\vec{x};\vec{p})} \nonumber \\
        &=  \expEvnts  - \sum_e^n \ln\parenthesis{\expEvnts \; \mathcal{P}(\vec{x};\vec{p}) } + {\rm const}.
\label{extloglikelihood}
\end{align}

\noindent Note that constant terms in the likelihood, like $\ln n!$, affect neither the shape of the likelihood
nor the position of the minimum and can thus be omitted.

\subsubsection{\CP asymmetries as free parameters}
\label{cp_assymetries_and_total_decay_rate}
The raw asymmetry, $\Acp{\rm raw}$, discussed in \secref{experimentalAssym}, can be measured by counting
$\BsbarJpsiKst$ and $\BsJpsiKst$ decays and use them to determine:

\begin{equation}
\Acp{\text{raw}} \equiv \frac{\Nplus - \Nminus}{\Nplus + \Nminus},
\label{acp_mes}
\end{equation}

\noindent where $\Nplus$ and $\Nminus$ are the number of observed \BsbarJpsiKst and \BsJpsiKst respectively.
Going one step further, $\Acp{\text{raw}}$ can be implemented as a parameter to be estimated in the fit. The advantage
is that the statistical uncertainty propagation for these parameters is implicit in the likelihood thus avoiding
explicit calculations. In addition, the above quantities can then be estimated separately for each polarization.
In order to vary $\Acp{\text{raw}}$ in the fit it is necessary to re-parameterize them as follows:

\begin{align}
  \label{acp_param}
\Acp{i} = \frac{\Nplus\AmpPlSq{i} - \Nminus\AmpMnSq{i}}{\Nplus\AmpPlSq{i} + \Nminus\AmpMnSq{i} } & \\
\text{and} \quad \AmpSq{i} = &\frac{ \Nplus \AmpPlSq{i} - \Nminus\AmpMnSq{i}}{\Nplus + \Nminus},
\end{align}

\noindent where $\AmpPlSq{i}$ and $\AmpMnSq{i}$ are the polarized amplitude in the \BsbarJpsiKst
and \BsJpsiKst samples respectively. The above equations can be solved for $\AmpPlSq{i}$ and $\AmpMnSq{i}$. The idea
is that the latter parameters will be used as amplitudes for the \BsbarJpsiKst and \BsJpsiKst \pdfs respectively.
This way both samples are fitted simultaneously in one fit. Solving \equref{acp_param} for $\AmpSq{\pm}$ yields:

\begin{equation}
\AmpPlSq{i} = \xi \; \AmpSq{i} (1+\Acp{i}) \,\, \text{and}\;\; \AmpMnSq{i} = \frac{\xi}{2\xi-1} \AmpSq{i} (1-\Acp{i}).
\label{acp_free}
\end{equation}

\noindent The $\AmpPlSq{i}$ and $\AmpMnSq{i}$ are the amplitude expressions that are used along with the angular functions of \tabref{ang_terms}.
The normalization factors in front of them can be re-expressed as function of $\Acp{\text{raw}}$ using \equref{acp_mes}.

\begin{align}
\xi = \frac{\Nplus+\Nminus}{2\Nplus} &= \frac{1}{2}\left( 1 + \frac{\yieldMn{}}{\yieldPl{}}\right) = \nonumber \\
                                     &= \frac{1}{2}\left( 1 + \frac{1-\Acp{\text{raw}}}{1+\Acp{\text{raw}}}\right) =
                                        \frac{1}{1+\Acp{\text{raw}}},  \\
\frac{\xi}{2\xi-1} = \frac{1}{2-\nicefrac{1}{\xi}} &= \frac{1}{1-\sum_i\Acp{\text{raw}}}.
\label{amp_norms}
\end{align}

\noindent Now, the quantities that are actually estimated in the likelihood fit are the $\AmpSq{i}$ with $i:\{0,\parallel,\perp,S\}$.
Having said that, and by looking at \equref{acp_free}, one understands that in order for $\AmpPlSq{i}$ and $\AmpMnSq{i}$
to be meaningful and consistent, the sum of all amplitudes $\sum\AmpSq{i}$ (with $i:{0,\parallel,\perp,S}$ ) must add up to one.
Thus imposing the condition $\sum\AmpSq{i} = 1$ one can re-express the $\AmpSq{i}$ as relative fractions:

\begin{equation}
\AmpSq{S} = \fS{} \;\;\;\text{and}\;\;\; \AmpSq{k} = (1-\fS{})\fP{k}.
\label{amps_param}
\end{equation}

\noindent Note that the \pwave fractions are also constrained so that they add up to one by imposing $\sum\fP{k}=1$ with $k:\{0,\parallel,\perp\}$.
The fractions $\fP{k}$ and $\fS{}$ are the actual parameters that one wishes to estimate and correspond to these used in the subsequent analysis of
\chapref{Penguins}. The final expressions of the $\AmpSqPm{i}$ after the above is given by:

\begin{equation}
\AmpSqPm{k} = \frac{1\pm\Acp{k}}{1\pm\sum_i\Acp{i}}  (1-\fS{})\fP{k}  \;\;\; \text{and}\;\;\; \AmpSqPm{S} = \frac{1\pm\Acp{S}}{1\pm\sum_i\Acp{i}} \; \fS{},
\label{amps_final}
\end{equation}

\noindent where the $i$ index runs through all amplitudes whereas $k$ only runs through the \pwave amplitudes.

There is one final step required to build the complete extended \pdf. That is the normalization of each component \pdf. Tempting as it might be to
normalize the component \pdfs to the number of observed candidates it would be wrong since the observed number of candidates are diluted by production and detection
asymmetry. Given that the parameters of interest, $\Acp{i}$, quantify the difference between the observed \BsbarJpsiKst and \BsJpsiKst decays, it follows that
the observed number of these decays need to be corrected for. With input from \secref{experimentalAssym} where the production and detection
asymmetries were estimated, the observed yields are made dependent on the $\Acp{i}$ asymmetry as:

\begin{subequations}
  \label{acp_yields}
  \begin{align}
    \yieldPl{\CP} &= \frac{ \yieldRaw{\text{total}} }{2} \left( \fS{}\; \Acp{S} + \sum_k^{0,\parallel,\perp} (1-\fS{})\fP{k}\Acp{k}  \right), \\
    \yieldMn{\CP} &=  \yieldRaw{\text{total}} - \yieldPl{\CP}
  \end{align}
\end{subequations}

\noindent and then subsequently corrected for the production and detection asymmetry resulting in:

\begin{equation}
\yield{\pm} = \yield{\pm}_{\CP}  \left( 1 \pm \Adet \mp \Aprod \right).
\label{norm_yields}
\end{equation}

\noindent The above yields are the expected number of candidates in the extended likelihood term of the \pdfs as discussed earlier.
