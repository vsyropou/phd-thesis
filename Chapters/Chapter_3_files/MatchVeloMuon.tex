In \runone all \velo tracks in \hltone were filtered by the \mvm algorithm. The latter performs a quick check,
given the muon stations hits, on wheather a \velo track is comaptible with being identified as a muon by the subsecuent
tracking algorithms, before these algorithms are actualy run. If the \velo track passes certain simple requirements it
is accepted, otherwise it is discarded permanently and not processed further by the \hlt muon lines. As a result
valuable computing time is saved, since the \FwD tracking and fiting algorithms are time costly.

\subsection{The MatchVeloMuon algorithm}
\label{sec:muon_matching}

The \mvm alogorithm, as it was implemented for \runone \cite{roelThesis}, takes a VELO track{\color{red} define velo track} as input
and searches for hits inside a search window, also know as {\it Filed of interest} (FoI), in the M3 muon station.
M3 is the first station to search for hits for two reasons. First the occupancy{\color{red} define} in M2 is very high{\color{red}see roel plot}
thus an initial a single VELO track candidate would create
a huge number of seed hits{\color{red} define seeding}. Second the muon reconstruction algorithm (\isMuon) will always fail if
there is no M3 muon hit asigned to a VELO track.

As it can be seen in \figref{}, the \lhcb magnet is between the \velo tracker and the and muon system.
The \lhcb magnetic field deflects tracks based on their momentum. The lower the momentum of a atrack the more
it is deflected by the magnetic field. Since, no momentum or charge information is available for the \velo
track before the \FwD algorithm is run, the size of the M3 FoI is defined assuming a minimum track momentum of 6 \gevc.
This particular momentum value corresponds to the lowest momentum tracks that the subsequent \isMuon algorithm accepts.

After considering all the M3 muons hits inside the FoI, additional muon hits are added to
the M3 seed hits by extrapolating from each M3 seed hit further to the rest of the muon stations.
Since there is no magnetic field between the muons stations the above mentione extrapolations are simple straight lines.
The corresponding FoIs for the rest of the muon stations are smaller since there is no deflection involved.
These FoIs account for the fact that the presence of heavy material between the muon stations change the
trajectory of a muon passing thorough, this effect is called multiple scattering, {\color{red} cite panos or other shit.}
and it is more pronounced for low momentum tracks.

At least 3 hits in the muon stations M2-M5 are required by the \mvm algorithm in order to accept the initial VELO track.
At the end of this procedure all {\it muon candidate tracks} that could result from an initial VELO track were considered.
Within the scope of the current chapter a muon candidate track is defined as the track formed by muon hits only.
Note that at this stage of the algorithm an estimate of the momentum of the initial VELO track becomes available
for each candidate muon track using the kick method \cite{roelThesis}, {\color{red} there is a better citation for that.}.
The kick method provides an estimate of the track momentum given the change in its slope when passing through a magnetic
field of a given streagth. The relation between the change in slope and the track momentum is empiracally estimated
in \cite{roelThesis}.

As a last step the candidate muon tracks originating from the above procedure are filtered by a $\chisq/{\rm DoF}$
requirement. The \chisq is simple to compute since there is no magnetic field in the region of the muon stations
and all tracks are in principle almost straight lines, taking into account the presence of multiple scattering, mentioned above.
The \chisq requirement reduces the chances that random combinations of muon hits can fake a real muon track.
The requirement is particularly usefull for low momentum tracks for which the number of M3 seed hits is larger,
due to larger corresponding M3 FoI, and thus the number of posible random combinations of muon tracks incereases.

An important detail that increases the discriminating power of the above mentioned \chisq requirement is the
so called {\it magnet hit}. The last is not a hit comming from a tracking station but rather the $(x,y)$ coorodinates
of the $z$ focal plane of the \lhcb magnet. The focal plane is essentially the plane defiend by the $z$ coordinate
where the change in the slope of a track, due to the magnetic field,  "instantaneously" takes place. Note that this
instantaneous change in slope is an approximation. In reality the track follows a smooth trajectory inside the whole
area of the amgnetc field, see {\color{red} ecent dispalay}. However estimating this trajectory uses valuable computation time during \hltone, while
\mvm can perform efficiently enough without a smooth track trajectory using the focal pane approximation.
The position of the $z$ focal plane has been studied \cite{} and used in the \mvm algorithm.
As mentioned in the begining of the paragraph including the magnet hit helps rejecting fake muon tracks.
Including the magnet hit in the \chisq essentialy requires that the muon hits are aligned in a straight line that
also passes from the magnet hit, which is true for real muon tracks only.

% The distance between the magnet hit and
% the muon system also plays a role, since the pointing of a fake muon track within a given hit resolution
% , $\sim 10 \m$, compared to the one
% between the muon hits, $\sim 1 \m$.

\subsection{Upgrade to MatchVeloTTMuon}
\label{sec:matchvelottmuon}
As mentioned in \secref{muid_hlt1}, improvements in the computing infrasstructure allowed for all the tracks
above 500\mev to be directly updated to long tracks and fitted. In addtion the velocandidates are upgraded to
VeloTT which they have a mometum and charge estimate and lower ghost rate as well. Meaning a more pure velo track candidates.
Now as far as tracks below that threshold,
hearafter refered to as low momenta tracks, there are several things that can be exploited such that
the low pt threshold is pushed further increasing the effiency of low pt tracks, while keepign the \hlt rate
at a managable level.

MVM is improved in those steps(smaller foI, magnetic field paramterization, chisq)

As described in \cite{LHCb-PUB-2015-005} in the \runtwo data-taking all the tracks are upgraded as VELO-TT segments, {\color{red} define}
exploiting information from the \ttracker tracking station which, being closer to the magnet,
guarantees a first momentum estimated. As already said, forward tracking is then passed on
all tracks above 500 \mevc of \pt.

For tracks below 500 \mevc of \pt the \mvm algorithm could still recover efficiency for the muon lines,
however in view of the already upgraded VELO-TT tracks, this tool was rewritten in order to better exploit these tracks.


\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_p}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_p}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.
 The efficiency is projected versus total (left column) and transverse (right column) momentum.  }
 \label{mvm_eff_p_comp}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.
 The efficiency is projected versus total (left column) and transverse (right column) momentum.  }
 \label{mvm_eff_p_comp}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.
 The efficiency is projected versus total (left column) and transverse (right column) momentum.  }
 \label{mvm_eff_p_comp}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_chi2_sigp_bigger}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/chi2_sigp_bigger_10000}}
    \caption{}
    \label{mvTTm_chi2}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_chi2_sigp_smaller}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/chi2_sigp_smaller_10000}}
    \caption{}
    \label{mvm_chi2}
  \end{subfigure}
  \caption{\chisq comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.}
 \label{mvm_chi2_comp}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_x}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_x}}
    \caption{}
    \label{mvTTm_res_x}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_y}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_y}}
    \caption{}
    \label{mvm_res_y}
  \end{subfigure}
  \caption{Residulas.  }
 \label{mvm_res}
\end{figure}

\begin{figure}[h]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_pos_neg_dx_norm}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_pos_neg_dx_norm}}
    \caption{}
    \label{mvTTm_pos_neg_x_norm}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_wind_eff_pos_neg_dx_norm}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_pos_neg_dx_norm}}
    \caption{}
    \label{mvm_pos_neg_x_norm}
  \end{subfigure}
  \caption{positive negative normalised x residuals. }
 \label{mvm_pos_neg_x_norm_comp}
\end{figure}

% \begin{figure}[h]
%   \centering
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvTTm_wind_eff_bra}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_bra}}
%     \caption{}
%     \label{mvTTm_wind_eff_bra}
%   \end{subfigure}%
%   \hfill%
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvm_wind_eff_bra}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_bra}}
%     \caption{}
%     \label{mvm_wind_eff_bra}
%   \end{subfigure}
%   \caption{2D M3 residuals. }
%  \label{mvm_wind_eff_bra_comp}
% \end{figure}


In addition to the above mentioned improvement there are several more points that \mvm can benefit from.
First due to the fact that the \veloTTCand have momentum and charge information, it is possible to open better
FoI in M3 to search for seed hits. The sign information of \veloTTCand halves the FoI size
and the momentum knowledge reduces the FoI size further, since the assumption of a momentum of 6 \mev
is no longer necessary. The last carries a big improvement potential
since smaller FoIs implies less seed hits in M3 and thus less fake muon candidates and less processing time per input VELO track.

Furthermore, the \chisq fit that \mvm calculates is also improved since the vertical plane is added in \mvTTm. In more detail, the \chisq fit is a straight line fit
performed to all the possible muon candidate tracks that originate from the seed hits of a given initial VELO track. The fit used to be performed only in the horizontal
plane ($x$ coordinate ). Adding the vertical plane improves the discriminating power of the \chisq.

%% The \chisq distributions for two momentum ranges are show in \figref{fig:mvm_chiSq}

Finally, the efficiency curves after all the improvements are shown in \figref{fig:mvm_eff}.
Top row shows the efficiency for \mvm versus $p$ and \pt, whereas
the bottom one the \mvTTm. Both algorithms get the same input tracks, namely \veloTTCand.
For low momenta the improvement is clear, whereas for high momenta
there is no efficiency loss within the statistical uncertainties. However any potential loss
after 500 \mevc in \pt is not relevant since, as it was stated
in the beginning of the current section, \mvTTm runs only on tracks with low momenta.

\begin{table}[!h]
 \centering
 \caption{Timing comparison between the old \mvm and the new \mvTTm, for three representative \hltone trigger lines.}
 \label{tab:mvm_time_diff}
 \begin{tabular}{l c c c c}
  \toprule
                   & \multicolumn{2}{c}{\mvm}       & \multicolumn{2}{c}{\mvTTm}\\
  HLT1 line        &  per event [ms] &  total [s]  &  per event [ms] &  total [s] \\
  \midrule
  DiMuonHighMass   &        9.04     &     5.05    &     4.64        &     2.58   \\
  DiMuonLowMass    &        0.33     &     0.18    &     0.22        &     0.14   \\
  SingleMuonHighPT &        0.23     &     0.13    &     0.17        &     0.10   \\
  \bottomrule
 \end{tabular}

\vspace{0.5cm}
\end{table}

Furthermore, the per event processing time is also reduced by $\sim 20\% - 40 \%$ using \mvTTm
with respect to the old \mvm, see \tabref{tab:mvm_time_diff}.
This is clearly because of the less number of seed hits in M3 resulting from the smaller FoI. Lastly, an important caveat arises from the fact that there can be tracks
that are labelled as \veloTTCand but they actually do not have \ttracker hits. These tracks are normal high \pt tracks that pass through the \ttracker station's inner hole
where there is no active detector material.
Thus they are just copied to the list of output tracks when the \veloTTCand are reconstructed.
\mvTTm does not discard this type of tracks either but deals with them properly
by invoking the old \mvm algorithm for such type of tracks.

%% \begin{table}
%%   \centering
%%  \caption{skase}
%% \label{tab:mvm_fine_tune}
%%   \begin{tabular}{ c c c c c }
%%    \toprule
%%    $\nicefrac{\text {foiX}}{\chi^2}$ &   5  &   10  &   20  &   30      \\
%%   \midrule
%%   x3 &  97.2 &  97.7 &  97.4 &  97.6  \\
%%   x4 &  97.8 &  98.1 &  97.9 &  98.1  \\
%%   x5 &  98.5 &  98.8 &  98.7 &  98.8  \\
%%   x6 &  98.5 &  98.8 &  98.8 &  98.9  \\
%%   x7 &  98.8 &  99.1 &  99.3 &  99.3  \\
%%   x8 &  98.8 &  99.1 &  99.3 &  99.3  \\
%%   x9 &  98.8 &  99.1 &  99.3 &  99.3  \\
%%  \bottomrule
%%   \end{tabular}
%% \end{table}
