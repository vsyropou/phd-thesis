In \runone all \veloTracks in \hltone were filtered by the \mvm algorithm. The latter performs a quick check,
given the muon stations hits, on wheather a \veloTrack is comaptible with being identified as a muon by the subsecuent
tracking algorithms, before these algorithms are actualy run. If the \veloTrack passes certain simple requirements it
is accepted, otherwise it is discarded permanently and not processed further by the \hlt muon lines. As a result
valuable computing time is saved, since the \FwD tracking and fiting algorithms are time costly.

\subsection{The MatchVeloMuon algorithm}
\label{sec:muon_matching}

The \mvm alogorithm, as it was implemented for \runone \cite{roelThesis}, takes a VELO track{\color{red} define velo track} as input
and searches for hits inside a search window, also know as {\it Filed of interest} (FoI), in the M3 muon station.
M3 is the first station to search for hits for two reasons. First the occupancy{\color{red} define} in M2 is very high{\color{red}see roel plot}
thus an initial a single VELO track candidate would create
a huge number of seed hits{\color{red} define seeding}. Second the muon reconstruction algorithm (\isMuon) will always fail if
there is no M3 muon hit asigned to a VELO track.

As it can be seen in \figref{}, the \lhcb magnet is between the \velo tracker and the and muon system.
The \lhcb magnetic field deflects tracks based on their momentum. The lower the momentum of a atrack the more
it is deflected by the magnetic field. Since, no momentum or charge information is available for the \veloTrack
before the \FwD algorithm is run, the size of the M3 FoI is defined assuming a minimum track momentum of 6 \gevc.
This particular momentum value corresponds to the lowest momentum tracks that the subsequent \isMuon algorithm accepts.

After considering all the M3 muons hits inside the FoI, additional muon hits are added to
the M3 seed hits by extrapolating from each M3 seed hit further to the rest of the muon stations.
Since there is no magnetic field between the muons stations the above mentione extrapolations are simple straight lines.
The corresponding FoIs for the rest of the muon stations are smaller since there is no deflection involved.
These FoIs account for the fact that the presence of heavy material between the muon stations change the
trajectory of a muon passing thorough, this effect is called multiple scattering, {\color{red} cite panos or other shit.}
and it is more pronounced for low momentum tracks.

At least 3 hits in the muon stations M2-M5 are required by the \mvm algorithm in order to accept the initial VELO track.
At the end of this procedure all {\it muon candidate tracks} that could result from an initial VELO track were considered.
Within the scope of the current chapter a muon candidate track is defined as the track formed by muon hits only.
Note that at this stage of the algorithm an estimate of the momentum of the initial VELO track becomes available
for each candidate muon track using the kick method \cite{roelThesis}, {\color{red} there is a better citation for that.}.
The kick method provides an estimate of the track momentum given the change in its slope when passing through a magnetic
field of a given streagth. The relation between the change in slope and the track momentum is empiracally estimated
in \cite{roelThesis}.

As a last step the candidate muon tracks originating from the above procedure are filtered by a $\chisq/\nDoF$
requirement. The \chisq is simple to compute since there is no magnetic field in the region of the muon stations
and all tracks are in principle almost straight lines, taking into account the presence of multiple scattering, mentioned above.
The \chisq requirement reduces the chances that random combinations of muon hits can fake a real muon track.
The requirement is particularly usefull for low momentum tracks for which the number of M3 seed hits is larger,
due to larger corresponding M3 FoI, and thus the number of posible random combinations of muon tracks incereases.

An important detail that increases the discriminating power of the above mentioned \chisq requirement is the
so called {\it magnet hit}. The last is not a hit comming from a tracking station but rather the $(x,y)$ coorodinates
of the $z$ focal plane of the \lhcb magnet. The focal plane is essentially the plane defiend by the $z$ coordinate
where the change in the slope of a track, due to the magnetic field,  "instantaneously" takes place. Note that this
instantaneous change in slope is an approximation. In reality the track follows a smooth trajectory inside the whole
area of the amgnetc field, see {\color{red} ecent dispalay}. However estimating this trajectory uses valuable computation time during \hltone, while
\mvm can perform efficiently enough without a smooth track trajectory using the focal pane approximation.
The position of the $z$ focal plane has been studied \cite{} and used in the \mvm algorithm.
As mentioned in the begining of the paragraph including the magnet hit helps rejecting fake muon tracks.
Including the magnet hit in the \chisq essentialy requires that the muon hits are aligned in a straight line that
also passes from the magnet hit, which is true for real muon tracks only.

% The distance between the magnet hit and
% the muon system also plays a role, since the pointing of a fake muon track within a given hit resolution
% , $\sim 10 \m$, compared to the one
% between the muon hits, $\sim 1 \m$.

\subsection{Upgrade to MatchVeloTTMuon}
\label{sec:matchvelottmuon}
As mentioned in \secref{muid_hlt1}, due to the inceased \hltone rate in \runtwo it becomes possible to
remove the \mvm algorithm form the sequence of the \hltone muon lines and upgrade all \veloTracks with $\pt>500 \mevc$ to long tracks and fit them.
Furthermore, another improvement is the use of information from the \ttracker tracker when reconstructing \veloTracks \cite{LHCb-PUB-2015-005}.
Note that, the \ttracker is posistioned close enough to the \lhcb magnet to allow for a first track momentum estimate.
The \ttracker momentum resolution is inferior, $\sim 15\%$, compared to the one of long tracks. However filtering
\veloTracks with \ttracker information increases the purity\footnote{by reducing the number of a type of fake tracks called {\it ghost tracks}, see {\color{red} cite ghost}}.
The above mentioned improvements offer oportunities for reconstructing muons with $\pt<500 \mevc$, hearafter low momenta muons,
by upgrading the old \mvm algorithm. The upgraded alrorithm is used by newlly introdced \hltone muon lines which aim
at reconstructing low \pt muons.

The upgraded \mvTTm algorithm improves in three points with respect to the old \mvm algorithm.
First the newly available momentum, and hence charge, information from the \ttracker is used to open smaller M3 FoIs.
This reduces the number of M3 seed hits and hence increases the purity of the \mvTTm algorithm, since the number of
random combinations that coould fake a muon reduces with the number of M3 seed hits.
Second, the parametrization of the magnet $z$ focal plane as well as the errors on the magnet hit $(x,y)$ coordinates
are tuned using simulated data. Lastly the vertical, non-bending, $y$ plane is included in the \chisq
computation\footnote{Note that the $y$ projection of a track is almost a straight line, since the magnetic field is parallel to the $y$ axis
and thus exherting no force along this direction.}, which was not the case in the old \mvm algoritm.
The last two impovements both incerease the discriminating power of the \chisq.
Lastly, an important caveat arises from the fact that there can be \veloTTracks that they do not have any information from
the \ttracker. These tracks are normal high momentum tracks that pass through the \ttracker station's inner hole
where there is no active detector material. Since there is no reason to discard these tracks the upgraded \mvTTm treats
those tracks as the old \mvm algorithm did\footnote{Meaning that the M3 FoI are big enough to include the posibility for
both positively and negatively charged tracks, see \cite{roelThesis}}.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old (left) and new (right) matching algorithms in bins of transverse momentum.}
 \label{mvm_eff_pt_zoom_comp}
\end{figure}

After the improvements mentioned in the above paragraph took place, the efficiency of the upgraded \mvTTm algorithm
is estimated versus the total and transverse momentum and compared with the old algorithm. A common cutoff value for
the $\chisq/\nDoF$ of 2 is chosen for a fair comparision. The efficiency projected verseus the total momentum, $\ptot$
can be seen in \figref{mvm_eff_p_comp}, where the imrovement of the upgraded \mvTTm agorithm are significant.
Given that the aim of the \mvTTm upgrade is to optimise for high efficiency of low transverse momenta muons,
the efficiency is also projected versus $\pt$ and shown in \figref{mvm_eff_pt_zoom_comp}. As mentioned in \secref{muid_hlt1}
all the high $\pt$ muons will not be processed by the \mvTTm algorithm the last figure focuses on the region where $\pt\in[0,0.5]\gevc$.
The relative efieciency increase with respect to the old \mvm algorithm in the last region is $\sim 50\%$.
For the efficiency studies simulated \Sigmapmumu events were used, where the mean transverse momentum is $\sim 300\mevc$.
Finally, the improvement of the $\chisq/\nDoF$ disriminating power between the old and upgraded algorithm is shown in \figref{mvm_chi2_comp}.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/vim_efficiency_p}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_p}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old (left) and new (right) matching algorithms in bins of total momentum.}
 \label{mvm_eff_p_comp}
\end{figure}

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_chi2_sigpt_smaller}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/chi2_sigpt_smaller_500}}
    \caption{}
    \label{mvTTm_chi2}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_chi2_sigpt_smaller}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/chi2_sigpt_smaller_500}}
    \caption{}
    \label{mvm_chi2}
  \end{subfigure}
  \caption{Distribution of the \chisq variable between the old (left) and the new (right) matching algorithms.
           Only low momentum \veloTracks are considered.}
 \label{mvm_chi2_comp}
\end{figure}

\subsubsection{z focal plane parametrization}
The emperical parametrization of the magnet focal plane $z$ coordinate \cite{blah}, already used in  the old \mvm,
is corrected using simulated data. The correction is a function of the inverse momentum. It is extracted by comparing
a proper extrapolation, that describes the magnetic field, with the kick method. The correction is based on the fact
that a good estimate of the z magnet coordinate is the one that gives a momentum estiamte as close to the one from MC.

For the erros something similar is done but I still need to study it a bit. (this correction was done after i submitted my code.)

\subsubsection{M3 Field of Intereset}
As explained in \secref{sec:muon_matching} the M3 FoI $x$ coordintes are computed assuming a minimum track momentum, and thus maximum deflection,
of $6\gevc$. For a $6\gevc$ muon the deflection caused by the \lhcb magnet is computed using the empirical paramtetrization mentioned in Section blah of \cite{roelThesis}.
Using this techinique makes it possible to estimate the region in M3 that a muon track will arrive at without performing the computation
expensive calculation of its trajectory through the \lhcb magnet, also refered to track {\it extrapolation}. In order to visualise the FoI sizes,
simulated events are used to compute the distance of the true hit in M3 from the middle of the FoI, respectivelly in the $x$ and $y$ planes.
The results are shown in \figref{mvm_res}. The average FoI half-width is $2.7\m$ and $0.4\m$ respectivelly for the $x$ and $y$ planes.
Which imples that most of the times the true hit is inside the FoI. The outliers in the \figref{mvTTm_res_x} in with $|d^{M3}|>3\m$
correspond to cases were the track charge estimate by the \ttracker is wrong. Remember that charge information is used to
look for hits only in the one side of the M3 station. Lastly the y plane is the non-bending plane hence the FoI sizes
are smaller, compared to the ones for the $x$ plane, since only multiple scattering is present in that plane.


\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_x}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_x}}
    \caption{}
    \label{mvTTm_res_x}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_y}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_y}}
    \caption{}
    \label{mvm_res_y}
  \end{subfigure}
  \caption{Hit pseudo-residuals in M3. The distributions correspond to the distnace between the center of the FoI and the true M3 hit
           in the $x$ (left) and $y$ (right) planes respectively.}
 \label{mvm_res}
\end{figure}

\subsubsection{\hltone timming and rate considerations}
After all the improvemntes the \mvTTm algorithm needs to be tunded to comply with the \hltone output rate of 12
\khz mentioned in \secref{sec:muon_matching}. Given that the cutoff $\chisq/\nDoF$ value of the upgraded \mvTTm is chosen to be 2.
Based on the signal and background distributions of \figref{mvTTm_chi2}, the last value imples that a \veloTrack which
is accepted by the \mvTTm algorithm has {\color{red} X (to be computed)} percent probability of being
a real muon and {\color{red} Y (to be computed)} percent to originate frm random combiantions in the muon stations. The overal \mvTTm efficiency in the $\pt<0.5\gevc$
for the above cutoff value is $\epsilon = 55 \pm 1.5 \%$. In addition it was checked that the changes introduced in the upgraded \mvTTm algorithm
do not ncrease the excecution time. It turns out that the procesing time per input track is actually smaller comapred to
the old \mvm, this improvement is attributed to the reduced number of M3 seed hits.

\subsubsection{Possible imporvements}
\begin{itemize}
  \item velo UT increased momentum estimate 5 percent
  \item Given that use offline FoIs, which are momentum dependant and thus smaller. save time and reduce background.
\end{itemize}
