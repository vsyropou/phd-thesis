In \runone all \veloTracks in \hltone were filtered by the \mvm algorithm. The latter performs a quick check,
given the muon stations hits, on wheather a \veloTrack is comaptible with being identified as a muon by the subsecuent
tracking algorithms, before these algorithms are actualy run. If the \veloTrack passes certain simple requirements it
is accepted, otherwise it is discarded permanently and not processed further by the \hlt muon lines. As a result
valuable computing time is saved, since the \FwD tracking and fiting algorithms are time costly.

\subsection{The MatchVeloMuon algorithm}
\label{sec:muon_matching}

The \mvm alogorithm, as it was implemented for \runone \cite{roelThesis}, takes a VELO track{\color{red} define velo track} as input
and searches for hits inside a search window, also know as {\it Filed of interest} (FoI), in the M3 muon station.
M3 is the first station to search for hits for two reasons. First the occupancy{\color{red} define} in M2 is very high{\color{red}see roel plot}
thus an initial a single VELO track candidate would create
a huge number of seed hits{\color{red} define seeding}. Second the muon reconstruction algorithm (\isMuon) will always fail if
there is no M3 muon hit asigned to a VELO track.

As it can be seen in \figref{}, the \lhcb magnet is between the \velo tracker and the and muon system.
The \lhcb magnetic field deflects tracks based on their momentum. The lower the momentum of a atrack the more
it is deflected by the magnetic field. Since, no momentum or charge information is available for the \veloTrack
before the \FwD algorithm is run, the size of the M3 FoI is defined assuming a minimum track momentum of 6 \gevc.
This particular momentum value corresponds to the lowest momentum tracks that the subsequent \isMuon algorithm accepts.

After considering all the M3 muons hits inside the FoI, additional muon hits are added to
the M3 seed hits by extrapolating from each M3 seed hit further to the rest of the muon stations.
Since there is no magnetic field between the muons stations the above mentione extrapolations are simple straight lines.
The corresponding FoIs for the rest of the muon stations are smaller since there is no deflection involved.
These FoIs account for the fact that the presence of heavy material between the muon stations change the
trajectory of a muon passing thorough, this effect is called multiple scattering, {\color{red} cite panos or other shit.}
and it is more pronounced for low momentum tracks.

At least 3 hits in the muon stations M2-M5 are required by the \mvm algorithm in order to accept the initial VELO track.
At the end of this procedure all {\it muon candidate tracks} that could result from an initial VELO track were considered.
Within the scope of the current chapter a muon candidate track is defined as the track formed by muon hits only.
Note that at this stage of the algorithm an estimate of the momentum of the initial VELO track becomes available
for each candidate muon track using the kick method \cite{roelThesis}, {\color{red} there is a better citation for that.}.
The kick method provides an estimate of the track momentum given the change in its slope when passing through a magnetic
field of a given streagth. The relation between the change in slope and the track momentum is empiracally estimated
in \cite{roelThesis}.

As a last step the candidate muon tracks originating from the above procedure are filtered by a $\chisq/\nDoF$
requirement. The \chisq is simple to compute since there is no magnetic field in the region of the muon stations
and all tracks are in principle almost straight lines, taking into account the presence of multiple scattering, mentioned above.
The \chisq requirement reduces the chances that random combinations of muon hits can fake a real muon track.
The requirement is particularly usefull for low momentum tracks for which the number of M3 seed hits is larger,
due to larger corresponding M3 FoI, and thus the number of posible random combinations of muon tracks incereases.

An important detail that increases the discriminating power of the above mentioned \chisq requirement is the
so called {\it magnet hit}. The last is not a hit comming from a tracking station but rather the $(x,y)$ coorodinates
of the $z$ focal plane of the \lhcb magnet. The focal plane is essentially the plane defiend by the $z$ coordinate
where the change in the slope of a track, due to the magnetic field,  "instantaneously" takes place. Note that this
instantaneous change in slope is an approximation. In reality the track follows a smooth trajectory inside the whole
area of the amgnetc field, see {\color{red} ecent dispalay}. However estimating this trajectory uses valuable computation time during \hltone, while
\mvm can perform efficiently enough without a smooth track trajectory using the focal pane approximation.
The position of the $z$ focal plane has been studied \cite{} and used in the \mvm algorithm.
As mentioned in the begining of the paragraph including the magnet hit helps rejecting fake muon tracks.
Including the magnet hit in the \chisq essentialy requires that the muon hits are aligned in a straight line that
also passes from the magnet hit, which is true for real muon tracks only.

% The distance between the magnet hit and
% the muon system also plays a role, since the pointing of a fake muon track within a given hit resolution
% , $\sim 10 \m$, compared to the one
% between the muon hits, $\sim 1 \m$.

\subsection{Upgrade to MatchVeloTTMuon}
\label{sec:matchvelottmuon}
As mentioned in \secref{muid_hlt1}, due to the inceased \hltone rate in \runtwo it becomes possible to
remove the \mvm algorithm form the sequence of the \hltone muon lines and upgrade all \veloTracks with $\pt>500 \mevc$ to long tracks and fit them.
Furthermore, another improvement is the use of information from the \ttracker tracker when reconstructing \veloTracks \cite{LHCb-PUB-2015-005}.
Note that, the \ttracker is posistioned close enough to the \lhcb magnet to allow for a first track momentum estimate.
The \ttracker momentum resolution is inferior, $\sim 15\%$, compared to the one of long tracks. However filtering
\veloTracks with \ttracker information increases the purity\footnote{by reducing the number of a type of fake tracks called {\it ghost tracks}, see {\color{red} cite ghost}}.
The above mentioned improvements offer oportunities for reconstructing muons with $\pt<500 \mevc$, hearafter low momenta muons,
by upgrading the old \mvm algorithm. The upgraded alrorithm is used by newlly introdced \hltone muon lines which aim
at reconstructing low \pt muons.

The upgraded \mvTTm algorithm improves in three points with respect to the old \mvm algorithm.
First the newly available momentum, and hence charge, information from the \ttracker is used to open smaller M3 FoIs.
This reduces the number of M3 seed hits and hence increases the purity of the \mvTTm algorithm, since the number of
random combinations that coould fake a muon reduces with the number of M3 seed hits.
Second, the parametrization of the magnet $z$ focal plane as well as the errors on the magnet hit $(x,y)$ coordinates
are tuned using simulated data. Lastly the vertical, non-bending, $y$ plane is included in the \chisq
computation\footnote{Note that the $y$ projection of a track is almost a straight line, since the magnetic field is parallel to the $y$ axis
and thus exherting no force along this direction.}, which was not the case in the old \mvm algoritm.
The last two impovements both incerease the discriminating power of the \chisq.
Lastly, an important caveat arises from the fact that there can be \veloTTracks that they do not have any information from
the \ttracker. These tracks are normal high momentum tracks that pass through the \ttracker station's inner hole
where there is no active detector material. Since there is no reason to discard these tracks the upgraded \mvTTm treats
those tracks as the old \mvm algorithm did\footnote{Meaning that the M3 FoI are big enough to include the posibility for
both positively and negatively charged tracks, see \cite{roelThesis}}.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_pt_zoom}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_pt_zoom}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.
 The efficiency is projected versus total (left column) and transverse (right column) momentum.  }
 \label{mvm_eff_pt_zoom_comp}
\end{figure}

After the improvements mentioned in the above paragraph took place, the efficiency of the upgraded \mvTTm algorithm
is estimated versus the total and transverse momentum and compared with the old algorithm. A common cutoff value for
the $\chisq/\nDoF$ of 2 is chosen for a fair comparision. The efficiency projected verseus the total momentum, $\ptot$
can be seen in \figref{mvm_eff_p_comp}, where the imrovement of the upgraded \mvTTm agorithm are significant.
Given that the aim of the \mvTTm upgrade is to optimise for high efficiency of low transverse momenta muons,
the efficiency is also projected versus $\pt$ and shown in \figref{mvm_eff_pt_zoom_comp}. As mentioned in \secref{muid_hlt1}
all the high $\pt$ muons will not be processed by the \mvTTm algorithm the last figure focuses on the region where $\pt\in[0,0.5]\gevc$.
The relative efieciency increase with respect to the old \mvm algorithm in the last region is $\sim 50\%$.
For the efficiency studies simulated \Sigmapmumu events were used, where the mean transverse momentum is $\sim 300\mevc$.
Finally, the improvement of the $\chisq/\nDoF$ disriminating power between the old and upgraded algorithm is shown in \figref{mvm_chi2_comp}.

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/vim_efficiency_p}}
    \caption{}
    \label{mvTTm_eff_p}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_efficiency_p}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/vim_efficiency_p}}
    \caption{}
    \label{mvm_eff_p}
  \end{subfigure}
  \caption{Efficiency comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.
 The efficiency is projected versus total (left column) and transverse (right column) momentum.  }
 \label{mvm_eff_p_comp}
\end{figure}

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_chi2_sigpt_smaller}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/chi2_sigpt_smaller_500}}
    \caption{}
    \label{mvTTm_chi2}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_chi2_sigpt_smaller}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/chi2_sigpt_smaller_500}}
    \caption{}
    \label{mvm_chi2}
  \end{subfigure}
  \caption{\chisq comparison between the old \mvm (top row) and the new \mvTTm (bottom row) algorithms.}
 \label{mvm_chi2_comp}
\end{figure}

\subsubsection{z focal plane parametrization}
The formulas that are used are blah

\subsubsection{\hltone rate considerations}
The formulas that are used are blah


\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_x}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_x}}
    \caption{}
    \label{mvTTm_res_x}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvTTm_wind_eff_total_y}
    \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_total_y}}
    \caption{}
    \label{mvm_res_y}
  \end{subfigure}
  \caption{Residulas.  }
 \label{mvm_res}
\end{figure}

\begin{figure}[t]
  \centering
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_wind_eff_total_x}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/wind_eff_total_x}}
    \caption{}
    \label{mvTTm_res_x}
  \end{subfigure}%
  \hfill%
  \begin{subfigure}{0.5\textwidth}
    \tikzsetnextfilename{mvm_wind_eff_total_y}
    \scalebox{.6}{\input{Figures/Chapter3/MvM/wind_eff_total_y}}
    \caption{}
    \label{mvm_res_y}
  \end{subfigure}
  \caption{Residulas.  }
 \label{mvm_res}
\end{figure}

% \begin{figure}[h]
%   \centering
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvTTm_wind_eff_pos_neg_dx_norm}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_pos_neg_dx_norm}}
%     \caption{}
%     \label{mvTTm_pos_neg_x_norm}
%   \end{subfigure}%
%   \hfill%
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvm_wind_eff_pos_neg_dx_norm}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_pos_neg_dx_norm}}
%     \caption{}
%     \label{mvm_pos_neg_x_norm}
%   \end{subfigure}
%   \caption{positive negative normalised x residuals. }
%  \label{mvm_pos_neg_x_norm_comp}
% \end{figure}


% The optimization aims in pushing the low momenta boundary down while increasing the signal efficiency and keeping the output
% \hltone rate managable. Note that there are a LOT more low pt tracks.
%



% \begin{figure}[h]
%   \centering
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvTTm_wind_eff_bra}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_bra}}
%     \caption{}
%     \label{mvTTm_wind_eff_bra}
%   \end{subfigure}%
%   \hfill%
%   \begin{subfigure}{0.5\textwidth}
%     \tikzsetnextfilename{mvm_wind_eff_bra}
%     \scalebox{.6}{\input{Figures/Chapter3/MvTTM/wind_eff_bra}}
%     \caption{}
%     \label{mvm_wind_eff_bra}
%   \end{subfigure}
%   \caption{2D M3 residuals. }
%  \label{mvm_wind_eff_bra_comp}
% \end{figure}


\begin{table}[!h]
 \centering
 \caption{Timing comparison between the old \mvm and the new \mvTTm, for three representative \hltone trigger lines.}
 \label{tab:mvm_time_diff}
 \begin{tabular}{l c c c c}
  \toprule
                   & \multicolumn{2}{c}{\mvm}       & \multicolumn{2}{c}{\mvTTm}\\
  HLT1 line        &  per event [ms] &  total [s]  &  per event [ms] &  total [s] \\
  \midrule
  DiMuonHighMass   &        9.04     &     5.05    &     4.64        &     2.58   \\
  DiMuonLowMass    &        0.33     &     0.18    &     0.22        &     0.14   \\
  SingleMuonHighPT &        0.23     &     0.13    &     0.17        &     0.10   \\
  \bottomrule
 \end{tabular}

\vspace{0.5cm}
\end{table}
